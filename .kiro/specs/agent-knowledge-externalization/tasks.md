# 実装計画: エージェント知識の外部化

## 概要

交通費申請および経費申請エージェントのプロンプトファイルに埋め込まれているルールを外部ファイルに分離します。ルールテキストをagent_knowledgeフォルダに移動し、プロンプト生成関数が動的に読み込むように修正します。

## タスク

- [x] 1. agent_knowledgeフォルダとポリシーファイルの作成
  - agent_knowledgeフォルダを作成
  - __init__.pyを作成してPythonパッケージとして認識させる
  - _要件: 1.1, 1.2_

- [x] 2. 交通費申請ポリシーファイルの実装
  - [x] 2.1 travel_policies.pyを作成
    - get_travel_rules関数を実装
    - 日付チェックと金額チェックのルールテキストを含める
    - docstringで使用方法を説明
    - _要件: 1.1, 1.3, 1.4, 2.1, 2.2, 2.4, 2.5_
  
  - [ ]* 2.2 travel_policies.pyのユニットテストを作成
    - 関数の存在確認
    - ルールテキストに必要なセクションが含まれることを確認
    - 日付が正しく注入されることを確認
    - _要件: 6.4_

- [x] 3. 経費申請ポリシーファイルの実装
  - [x] 3.1 receipt_policies.pyを作成
    - get_receipt_rules関数を実装
    - 日付チェック、金額チェック、業務目的チェックのルールテキストを含める
    - docstringで使用方法を説明
    - _要件: 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5_
  
  - [ ]* 3.2 receipt_policies.pyのユニットテストを作成
    - 関数の存在確認
    - ルールテキストに必要なセクションが含まれることを確認
    - 日付が正しく注入されることを確認
    - _要件: 6.4_

- [x] 4. チェックポイント - ポリシーファイルの動作確認
  - すべてのテストが通ることを確認
  - ユーザーに質問があれば確認

- [x] 5. 交通費プロンプト生成関数の修正
  - [x] 5.1 prompt_travel.pyを修正
    - travel_policiesからget_travel_rulesをインポート
    - ルール取得関数を呼び出してルールテキストを取得
    - プロンプトにルールテキストを注入
    - エラーハンドリングを追加（ImportError、AttributeError、TypeError）
    - _要件: 3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.4_
  
  - [ ]* 5.2 prompt_travel.pyの統合テストを作成
    - プロンプト生成が成功することを確認
    - プロンプトにルールの内容が含まれることを確認
    - プロンプト構造が保持されることを確認
    - _要件: 6.5_

- [x] 6. 経費プロンプト生成関数の修正
  - [x] 6.1 prompt_receipt.pyを修正
    - receipt_policiesからget_receipt_rulesをインポート
    - ルール取得関数を呼び出してルールテキストを取得
    - プロンプトにルールテキストを注入
    - エラーハンドリングを追加（ImportError、AttributeError、TypeError）
    - _要件: 3.1, 3.2, 3.3, 3.4, 4.1, 4.3, 4.4_
  
  - [ ]* 6.2 prompt_receipt.pyの統合テストを作成
    - プロンプト生成が成功することを確認
    - プロンプトにルールの内容が含まれることを確認
    - プロンプト構造が保持されることを確認
    - _要件: 6.5_

- [x] 7. チェックポイント - プロンプト生成の動作確認
  - すべてのテストが通ることを確認
  - ユーザーに質問があれば確認

- [x] 8. プロパティベーステストの実装
  - [ ]* 8.1 プロパティテスト: ルールテキストの完全性
    - **Property 2: ルールテキストの完全性**
    - **検証: 要件 1.3, 1.4**
    - Hypothesisを使用して、すべてのルール取得関数が必要なセクションを含むことを確認
  
  - [ ]* 8.2 プロパティテスト: 日付の動的注入
    - **Property 3: 日付の動的注入**
    - **検証: 要件 2.1, 2.2**
    - Hypothesisを使用して、すべてのルール取得関数が引数の日付を含むことを確認
  
  - [ ]* 8.3 プロパティテスト: プロンプト構造の保持
    - **Property 5: プロンプト構造の保持**
    - **検証: 要件 3.3, 4.1**
    - Hypothesisを使用して、すべてのプロンプト生成関数が必要なセクションを含むことを確認

- [ ] 9. 後方互換性の検証
  - [-] 9.1 既存プロンプトとの比較テストを作成
    - 元のプロンプトと新しいプロンプトの内容を比較
    - ルールテキストが一致することを確認
    - _要件: 4.1, 4.5_
  
  - [ ]* 9.2 エージェント実行テストを作成
    - 交通費エージェントが正常に動作することを確認
    - 経費エージェントが正常に動作することを確認
    - _要件: 4.2, 4.3_

- [x] 10. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのユニットテストが通ることを確認
  - すべてのプロパティテストが通ることを確認
  - すべての統合テストが通ることを確認
  - ユーザーに質問があれば確認

## 注意事項

- `*`マークのタスクはオプションです（テスト関連）
- 各タスクは前のタスクが完了してから実行してください
- チェックポイントで問題が見つかった場合は、前のタスクに戻って修正してください
- プロンプトの内容が変わらないことを確認するため、既存のプロンプトと新しいプロンプトを比較してください
