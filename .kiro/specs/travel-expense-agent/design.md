# 設計書

## 概要

交通費申請の代行エージェントシステムは、AWS Strandsフレームワークを使用して構築されるマルチエージェントシステムです。Amazon Bedrockを活用した対話型インターフェースを通じて、ユーザーから移動情報を一区間ずつ収集し、ローカルのdataフォルダに保存された運賃データを参照して交通費を自動計算します。すべての区間の入力と確認が完了した後、最終確認を行い、ユーザーが選択した形式（PDFまたはJSON）で申請書を生成してローカルのOutputフォルダに保存します。

## 前提条件

システムを開発・実行する前に、以下の環境設定が必要です：

### 1. Python環境
- Python 3.10以上がインストールされていること

### 2. AWS CLI設定（最優先）
開発の一番最初に以下を実行する必要があります：

**Windows環境でのAWS CLIインストール:**

方法1: MSIインストーラー（推奨）
```powershell
msiexec.exe /i https://awscli.amazonaws.com/AWSCLIV2.msi
```

方法2: AWS公式サイトからダウンロード
- https://aws.amazon.com/cli/ にアクセス
- Windows用のインストーラーをダウンロードして実行

**AWS認証情報の設定:**
```bash
aws configure
```

`aws configure`実行時に以下の情報を入力：
- AWS Access Key ID
- AWS Secret Access Key
- Default region name: `ap-northeast-1`（東京リージョン）
- Default output format: `json`

### 3. Amazon Bedrockモデルアクセス
- AWS Management Consoleで、Amazon Bedrockの利用可能なモデルへのアクセスを有効化
- リージョン: ap-northeast-1（東京）

### 4. 必要なPythonパッケージ
```bash
pip install strands-agents
pip install strands-agents-tools
pip install strands-agents-builder
pip install hypothesis  # プロパティベーステスト用
pip install pytest      # ユニットテスト用
pip install reportlab   # PDF生成用
```

### 5. ディレクトリ構造
プロジェクトルートに以下のフォルダを作成：
- `data/`: 運賃データファイルを格納
- `output/`: 生成された申請書を保存

## アーキテクチャ

### システム構成

システムはマルチエージェント構成（Agents as Tools パターン）で実装されています：

```
┌─────────────────────────────────────────────────────────────┐
│                        ユーザー                              │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│          社内申請受付エージェント（オーケストレーター）        │
│              (ReceptionAgent)                               │
│                                                             │
│  役割: ユーザーの申請内容を分析し、適切な専門エージェントに   │
│        振り分ける                                           │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  専門エージェント1: travel_agent (Tool)                │  │
│  │  - 交通費精算代行                                      │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  専門エージェント2: receipt_expense_agent (Tool)       │  │
│  │  - 領収書精算代行                                      │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────┬────────────────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        │                         │
        ▼                         ▼
┌──────────────────┐    ┌──────────────────┐
│  交通費精算      │    │  領収書精算      │
│  専門エージェント │    │  専門エージェント │
│  (TravelAgent)   │    │  (ReceiptExpense │
│                  │    │   Agent)         │
│  ツール:         │    │  ツール:         │
│  - calculate_fare│    │  - image_reader  │
│  - validate_input│    │  - excel_generator│
│  - generate_report│   │  - config_updater│
└────────┬─────────┘    └────────┬─────────┘
         │                       │
         ▼                       ▼
┌─────────────────────────────────────────────────────────────┐
│                   Amazon Bedrock                            │
│              (Claude 4 Sonnet)                              │
└─────────────────────────────────────────────────────────────┘
         │                       │
         ▼                       ▼
┌─────────────────────────────────────────────────────────────┐
│                  ローカルストレージ                           │
│                                                             │
│  ┌──────────────┐         ┌──────────────┐                 │
│  │  dataフォルダ │         │ Outputフォルダ│                 │
│  │  - 運賃データ │         │  - 申請書     │                 │
│  └──────────────┘         └──────────────┘                 │
└─────────────────────────────────────────────────────────────┘
```

### Agents as Tools パターン

各専門エージェントは`@tool`デコレータでツール化され、オーケストレーターから呼び出されます：

- **シングルトンパターン**: 各エージェントは初回呼び出し時に初期化され、以降は同じインスタンスを再利用
- **会話履歴の保持**: `SlidingWindowConversationManager`により、複数回の呼び出しで会話コンテキストを維持
- **ストリーミング無効化**: `callback_handler=None`でマルチエージェント環境での出力重複を防止

### 処理フロー

1. **初期化フェーズ**
   - システム起動
   - AWS認証情報の確認
   - オーケストレーターエージェントの起動
   - 対話セッションの開始

2. **申請内容の受付フェーズ（オーケストレーター）**
   - ユーザーから申請内容を収集
   - 申請内容を分析して適切な専門エージェントを特定
   - 専門エージェントにリクエストを振り分け

3. **交通費精算フェーズ（travel_agent）**
   - 一区間ごとに経路情報を収集
   - 運賃データの読み込み（初回のみ）
   - 交通費の計算と確認
   - 次の区間の有無を確認
   - すべての区間完了後、最終確認
   - 申請書形式の選択（PDF/JSON）
   - 申請書の生成と保存

4. **領収書精算フェーズ（receipt_expense_agent）**
   - 領収書画像のパスを収集
   - 画像から情報を抽出（店舗名、金額、日付、品目）
   - 抽出情報の確認と修正
   - 経費区分の判断
   - Excel申請書の生成と保存

5. **完了フェーズ（オーケストレーター）**
   - 専門エージェントの処理完了を確認
   - 他に申請したい内容があるか確認
   - すべての申請完了後、処理を終了

## コンポーネントとインターフェース

### オーケストレーターエージェント (ReceptionAgent)

**責務:**
- ユーザーからの申請内容を受け付ける
- 申請内容を分析して適切な専門エージェントを特定
- 専門エージェントへのリクエスト振り分け
- 複数エージェントの処理を調整
- 全体の対話フローを管理

**システムプロンプト:**
```
あなたは社内申請受付AIエージェントです。
オーケストラレーターとしてユーザーからの申請依頼内容に応じて、
専門エージェントである「交通費精算代行エージェント(travel_agent)」と
「領収書精算代行エージェント(receipt_expense_agent)」のどちらか適切なエージェントに
業務を引き継いでください。

処理の流れ:
1. ユーザーから申請内容を収集
2. 申請内容を分析して最も適切な専門エージェントを特定
3. 各専門エージェントの処理が完了したら、他に申請したい内容があるか確認
4. すべての申請受付を終えたら、処理を終了

判断プロトコル:
- 顧客訪問や会議、出張などの移動で発生した交通費用の申請 → travel_agent
- 領収書画像を使った経費の申請、物品の購入費用、資格や研修費用、接待などの経費精算 → receipt_expense_agent
```

**利用可能なツール:**
- `travel_agent`: 交通費精算代行エージェント
- `receipt_expense_agent`: 領収書精算代行エージェント

### 専門エージェント1: TravelAgent (travel_agent)

**責務:**
- ユーザーから移動情報を一区間ずつ収集
- 交通費の計算
- 申請書の生成（PDF/JSON形式）
- 会話履歴の管理

**システムプロンプト:**
```
あなたは交通費申請を支援するAIエージェントです。
ユーザーから移動情報を一区間ずつ収集し、交通費を計算して申請書を作成します。

処理フロー:
1. ユーザーから一区間の移動情報（出発地、目的地、日付、交通手段）を収集
2. calculate_fareツールで交通費を計算
3. 計算結果をユーザーに確認
4. 次の区間の有無を確認
5. すべての区間の入力完了後、最終確認
6. 申請書形式(PDF/JSON)を質問
7. generate_reportツールで申請書を生成・保存
```

**利用可能なツール:**
- `calculate_fare`: 交通費の計算
- `validate_input`: 入力データの検証
- `generate_report`: 申請書の生成

**関数シグネチャ:**
```python
@tool
def travel_agent(query: str) -> str:
    """
    交通費申請代行ツール
    
    Args:
        query: ユーザーからの入力や質問
    
    Returns:
        str: エージェントからの応答
    """
```

### 専門エージェント2: ReceiptExpenseAgent (receipt_expense_agent)

**責務:**
- 領収書画像から情報を抽出
- 経費区分の判断
- Excel形式の申請書生成
- 設定管理（申請者名、出力先）

**システムプロンプト:**
```
あなたは領収書精算申請代行エージェントです。

役割:
1. 領収書画像の処理 - image_readerツールで情報を抽出
2. 経費区分の判断 - 品目を分析して適切な経費区分を判断
3. Excel申請書の生成 - excel_generatorツールで申請書を生成
4. 設定変更 - config_updaterツールで申請者名や出力先を更新

処理フロー:
1. ユーザーから領収書画像のパスを収集
2. image_readerツールで画像から情報を抽出
3. 抽出した情報をユーザーに確認
4. 必要に応じて修正を受け付ける
5. excel_generatorツールで申請書を生成・保存
```

**利用可能なツール:**
- `image_reader`: 領収書画像からの情報抽出（Strands公式ツール）
- `excel_generator`: Excel申請書の生成
- `config_updater`: 設定の更新

**関数シグネチャ:**
```python
@tool
def receipt_expense_agent(query: str) -> str:
    """
    領収書精算代行ツール
    
    Args:
        query: ユーザーからの入力や質問
    
    Returns:
        str: エージェントからの応答
    """
```

### ツール1: calculate_fare

**責務:**
- 経路データから交通費を計算
- 運賃データを参照
- 複数交通手段の合算

**関数シグネチャ:**
```python
@tool
def calculate_fare(
    departure: str,
    destination: str,
    transport_type: str,
    date: str
) -> dict:
    """
    経路の交通費を計算します。
    
    Args:
        departure: 出発地
        destination: 目的地
        transport_type: 交通手段（train/bus/taxi/airplane）
        date: 移動日（YYYY-MM-DD形式）
    
    Returns:
        dict: {
            "fare": float,           # 計算された運賃
            "calculation_method": str # 計算方法の説明
        }
    
    Raises:
        ValueError: 経路が運賃データに存在しない場合
    """
```

### ツール2: validate_input

**責務:**
- 日付、場所、費用の検証
- エラーメッセージの生成

**関数シグネチャ:**
```python
@tool
def validate_input(
    input_type: str,
    value: str
) -> dict:
    """
    入力データを検証します。
    
    Args:
        input_type: 検証タイプ（date/location/amount）
        value: 検証する値
    
    Returns:
        dict: {
            "valid": bool,           # 検証結果
            "error_message": str     # エラーメッセージ（無効な場合）
        }
    """
```

### ツール3: generate_report

**責務:**
- PDF/JSON形式の申請書生成
- Outputフォルダへの保存
- ファイル名の生成

**関数シグネチャ:**
```python
@tool
def generate_report(
    routes: List[dict],
    format: str,
    user_id: str
) -> dict:
    """
    交通費申請書を生成して保存します。
    
    Args:
        routes: 経路データのリスト
        format: 出力形式（pdf/json）
        user_id: ユーザー識別子
    
    Returns:
        dict: {
            "file_path": str,        # 保存されたファイルのパス
            "total_cost": float      # 合計経費
        }
    
    Raises:
        IOError: ファイル保存に失敗した場合
    """
```

### ツール4: image_reader

**責務:**
- 領収書画像からテキスト情報を抽出
- OCR処理

**提供元:** Strands公式ツール（`strands_tools`パッケージ）

### ツール5: excel_generator

**責務:**
- Excel形式の経費精算申請書を生成
- 承認ルールの適用（30,000円上限チェック）

**関数シグネチャ:**
```python
@tool
def excel_generator(
    store_name: str,
    amount: float,
    date: str,
    category: str,
    notes: str = ""
) -> dict:
    """
    Excel形式の経費精算申請書を生成します。
    
    Args:
        store_name: 店舗名
        amount: 金額
        date: 日付
        category: 経費区分
        notes: 備考（オプション）
    
    Returns:
        dict: {
            "success": bool,
            "file_path": str,
            "message": str
        }
    """
```

### ツール6: config_updater

**責務:**
- 申請者名や出力ディレクトリの設定を更新

**関数シグネチャ:**
```python
@tool
def config_updater(
    setting_name: str,
    value: str
) -> dict:
    """
    設定を更新します。
    
    Args:
        setting_name: 設定名（applicant_name/output_directory）
        value: 設定値
    
    Returns:
        dict: {
            "success": bool,
            "message": str
        }
    """
```

## データモデル

### RouteData（経路データ）

```python
@dataclass
class RouteData:
    """一区間の経路情報"""
    departure: str          # 出発地
    destination: str        # 目的地
    date: datetime          # 移動日
    transport_type: str     # 交通手段（train/bus/taxi/airplane）
    cost: float            # 計算された費用
    notes: Optional[str]   # 備考
```

### FareData（運賃データ）

```python
@dataclass
class TrainFare:
    """電車の運賃データ"""
    departure: str
    destination: str
    fare: float

@dataclass
class FixedFare:
    """固定運賃データ"""
    transport_type: str  # bus/taxi/airplane
    fare: float
```

### ExpenseReport（申請書）

```python
@dataclass
class ExpenseReport:
    """交通費申請書"""
    user_id: str
    report_date: datetime
    routes: List[RouteData]
    total_cost: float
    
    def to_dict(self) -> dict:
        """辞書形式に変換（JSON出力用）"""
        
    def to_pdf_content(self) -> str:
        """PDF生成用のコンテンツを作成"""
```

## 正確性プロパティ

プロパティとは、システムのすべての有効な実行において真であるべき特性や動作のことです。プロパティは、人間が読める仕様と機械で検証可能な正確性保証の橋渡しとなります。


### プロパティ1: 経路データ抽出の完全性

*すべての*自然言語入力に対して、エージェントが抽出する経路データは、出発地、目的地、日付、交通手段の必須フィールドを含む必要があります。

**検証: 要件 1.2**

### プロパティ2: 不完全情報のフォローアップ

*すべての*不完全な経路情報に対して、システムは不足しているフィールドを特定し、ユーザーにフォローアップ質問を行う必要があります。

**検証: 要件 1.3**

### プロパティ3: 曖昧情報の明確化要求

*すべての*曖昧な入力に対して、システムは処理を進める前にユーザーに明確化を要求する必要があります。

**検証: 要件 1.4**

### プロパティ4: コンテキストの維持

*すべての*対話セッション中、システムは複数のやり取りにわたって以前の経路情報と対話履歴を維持する必要があります。

**検証: 要件 1.5**

### プロパティ5: 運賃データ参照の正確性

*すべての*経路データに対して、システムは適切な運賃データソース（電車は運賃テーブル、バス/タクシー/飛行機は固定運賃）を参照して交通費を計算する必要があります。

**検証: 要件 2.1, 2.5, 2.6**

### プロパティ6: 一区間ごとの処理フロー

*すべての*区間入力に対して、システムは（1）交通費を計算し、（2）ユーザーに確認を求め、（3）次の区間の有無を確認する、という順序で処理を行う必要があります。

**検証: 要件 2.2, 2.3, 2.4**

### プロパティ7: 複数交通手段の合算

*すべての*複数の交通手段を含む経路に対して、システムは各交通手段の費用を正しく合算して合計費用を計算する必要があります。

**検証: 要件 2.7**

### プロパティ8: 要約表示の完全性

*すべての*経路要約表示に対して、各経路の出発地、目的地、日付、交通手段、費用のすべてのフィールドが含まれる必要があります。

**検証: 要件 3.3**

### プロパティ9: 修正時の再計算

*すべての*経路修正に対して、システムは影響を受ける費用を即座に再計算する必要があります。

**検証: 要件 3.6**

### プロパティ10: 形式選択に応じた生成

*すべての*申請書生成に対して、ユーザーが選択した形式（PDFまたはJSON）に対応するファイルが生成される必要があります。

**検証: 要件 4.2**

### プロパティ11: 申請書の完全性

*すべての*生成された申請書に対して、すべての経路の詳細が区間ごとに一覧形式で含まれ、合計経費金額が正しく計算されている必要があります。

**検証: 要件 4.3, 4.5**

### プロパティ12: ファイル保存の一貫性

*すべての*申請書保存に対して、ファイルはOutputフォルダに保存され、日付とユーザー識別子を含む命名規則に従う必要があります。

**検証: 要件 5.1, 5.2**

### プロパティ13: JSON形式の妥当性

*すべての*JSON形式の申請書に対して、生成されたファイルは有効なJSON構造を持ち、すべての経路データを含む必要があります。

**検証: 要件 5.6**

### プロパティ14: エラー時の状態保持

*すべての*エラー発生時に、システムは対話状態を保持し、ユーザーが処理を続行できるようにする必要があります。

**検証: 要件 6.4**

### プロパティ15: エラーログの記録

*すべての*エラーに対して、システムはトラブルシューティングのために詳細をログに記録する必要があります。

**検証: 要件 6.5**

### プロパティ16: 日付検証

*すべての*日付入力に対して、システムは有効な形式（YYYY-MM-DD等）と妥当な範囲（過去または近い未来）であることを検証する必要があります。

**検証: 要件 7.1**

### プロパティ17: 場所検証

*すべての*場所入力に対して、システムは場所が運賃データに存在する認識可能な場所であることを検証する必要があります。

**検証: 要件 7.2**

### プロパティ18: 費用検証

*すべての*手動費用入力に対して、システムは金額が正の数であることを検証する必要があります。

**検証: 要件 7.3**

### プロパティ19: 無効データの通知

*すべての*無効なデータ検出時に、システムはユーザーに通知し、修正を要求する必要があります。

**検証: 要件 7.4**

### プロパティ20: 無効データでの生成防止

*すべての*申請書生成試行に対して、システムは無効または不完全なデータを含む申請書の生成を防止する必要があります。

**検証: 要件 7.5**

### プロパティ21: 運賃データファイル不在時のエラー処理

運賃データファイルが存在しない場合、システムは適切なエラーメッセージを表示し、システムを安全に終了する必要があります。

**検証: 要件 9.4**

## エラーハンドリング

### エラーの種類と対応

1. **AWS Bedrock接続エラー**
   - 検出: Bedrock APIコール時の接続タイムアウトまたは認証エラー
   - 対応: ユーザーに通知し、AWS認証情報の確認を促す
   - 状態: 対話状態を保持し、再試行を許可

2. **運賃データ読み込みエラー**
   - 検出: dataフォルダのファイルが存在しない、または形式が不正
   - 対応: エラーメッセージを表示し、システムを終了
   - ログ: ファイルパスとエラー詳細を記録

3. **計算エラー**
   - 検出: 運賃データに該当する経路が見つからない
   - 対応: ユーザーに通知し、手動入力または経路修正を促す
   - 状態: 現在の経路データを保持

4. **ファイル保存エラー**
   - 検出: Outputフォルダへの書き込み権限がない、またはディスク容量不足
   - 対応: エラーを通知し、代替保存場所を提案
   - リトライ: 別のパスでの保存を試行

5. **入力検証エラー**
   - 検出: 日付、場所、費用の形式または範囲が不正
   - 対応: 具体的なエラー内容を通知し、再入力を要求
   - 状態: 他の有効なデータは保持

### エラーログ形式

```python
{
    "timestamp": "2025-01-16T10:30:00Z",
    "error_type": "FareDataNotFound",
    "severity": "ERROR",
    "message": "運賃データが見つかりません: 渋谷 -> 横浜",
    "context": {
        "route": {"departure": "渋谷", "destination": "横浜"},
        "user_id": "user123"
    }
}
```

## テスト戦略

### デュアルテストアプローチ

システムの正確性を保証するために、ユニットテストとプロパティベーステストの両方を実装します。

**ユニットテスト:**
- 特定の例とエッジケースを検証
- 統合ポイントのテスト
- エラー条件の確認

**プロパティベーステスト:**
- 普遍的なプロパティをすべての入力で検証
- ランダム化による包括的な入力カバレッジ

### プロパティベーステストの設定

- **テストライブラリ**: Hypothesis（Python用）
- **最小イテレーション数**: 各プロパティテストで100回
- **タグ形式**: `# Feature: travel-expense-agent, Property {番号}: {プロパティテキスト}`

### テストカバレッジ

1. **メインエージェント**
   - ユニットテスト: システム起動時の初期化、特定の対話フロー
   - プロパティテスト: プロパティ1-4（経路データ抽出、フォローアップ、明確化、コンテキスト維持）

2. **load_fare_dataツール**
   - ユニットテスト: 正常なファイル読み込み、ファイル不在時のエラー
   - プロパティテスト: プロパティ21（ファイル不在エラー処理）

3. **calculate_fareツール**
   - ユニットテスト: 各交通手段の固定運賃、特定の電車経路
   - プロパティテスト: プロパティ5-7（運賃データ参照、一区間処理、複数交通手段合算）

4. **validate_inputツール**
   - ユニットテスト: 有効/無効な日付、場所、費用の例
   - プロパティテスト: プロパティ16-20（日付検証、場所検証、費用検証、無効データ通知、生成防止）

5. **generate_reportツール**
   - ユニットテスト: PDF/JSON生成の基本例、ファイル命名規則
   - プロパティテスト: プロパティ8-13（要約表示、修正再計算、形式選択、申請書完全性、ファイル保存、JSON妥当性）

6. **エラーハンドリング**
   - ユニットテスト: 各エラータイプの具体例
   - プロパティテスト: プロパティ14-15（状態保持、ログ記録）

### テストデータ

**運賃データ（data/train_fares.json）:**
```json
{
  "routes": [
    {"departure": "東京", "destination": "新宿", "fare": 200},
    {"departure": "新宿", "destination": "渋谷", "fare": 170},
    {"departure": "渋谷", "destination": "品川", "fare": 200},
    {"departure": "品川", "destination": "横浜", "fare": 300}
  ]
}
```

**固定運賃データ（data/fixed_fares.json）:**
```json
{
  "bus": 220,
  "taxi": 1500,
  "airplane": 15000
}
```
