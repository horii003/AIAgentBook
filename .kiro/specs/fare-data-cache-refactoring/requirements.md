# 要件ドキュメント

## はじめに

このドキュメントは、運賃データキャッシュ機構の改修に関する要件を定義します。現在の実装では、グローバル変数を使用して運賃データをキャッシュしていますが、これにはスレッドセーフティの欠如、テスト困難性、データ改ざんリスク、メモリ管理の困難さ、依存性の不透明さといった問題があります。

本改修では、2つの異なるアプローチ（毎回ファイル読み込み vs シングルトンパターン）を実装可能な設計を提供し、パフォーマンス、保守性、テスタビリティを比較できるようにします。

## 用語集

- **運賃データマネージャー（Fare_Data_Manager）**: 運賃データの読み込みとキャッシュを管理するコンポーネント
- **キャッシュ戦略（Cache_Strategy）**: キャッシュの実装方式（毎回読み込み、またはシングルトン）
- **電車運賃データ（Train_Fare_Data）**: 電車の運賃データ（出発地、目的地、運賃を含む）
- **固定運賃データ（Fixed_Fare_Data）**: バス、タクシー、飛行機の固定運賃データ
- **運賃計算ツール（Fare_Calculation_Tool）**: 運賃を計算するツール関数
- **スレッドセーフティ（Thread_Safety）**: 複数のスレッドから同時にアクセスされても正しく動作する性質
- **シングルトンパターン（Singleton_Pattern）**: クラスのインスタンスが1つだけ存在することを保証する設計パターン
- **キャッシュ無効化（Cache_Invalidation）**: キャッシュされたデータを無効化し、再読み込みを強制する機能

## 要件

### 要件1: 運賃データの読み込み

**ユーザーストーリー:** 開発者として、JSONファイルから運賃データを読み込みたい。そうすることで、システムが正確に交通費を計算できるようにする。

#### 受け入れ基準

1. 運賃データマネージャーは、data/train_fares.jsonから電車運賃データを読み込むこと
2. 運賃データマネージャーは、data/fixed_fares.jsonから固定運賃データを読み込むこと
3. JSONファイルが存在しない場合、運賃データマネージャーは説明的なメッセージを含むFileNotFoundErrorを発生させること
4. JSONファイルに無効なJSON構文が含まれている場合、運賃データマネージャーは説明的なメッセージを含むJSONDecodeErrorを発生させること
5. 読み込まれたデータがPydanticバリデーションに失敗した場合、運賃データマネージャーは検証失敗の詳細を含むValidationErrorを発生させること
6. 運賃データマネージャーは、TrainFareRoute Pydanticモデルを使用して電車運賃データを検証すること
7. 運賃データマネージャーは、FareData Pydanticモデルを使用して固定運賃データを検証すること
8. 運賃データマネージャーは、"train_fares"と"fixed_fares"のキーを持つ辞書形式で運賃データを返すこと

### 要件2: キャッシュ戦略の実装

**ユーザーストーリー:** 開発者として、異なるキャッシュ戦略を選択したい。そうすることで、ユースケースに応じてシンプルさまたはパフォーマンスを最適化できるようにする。

#### 受け入れ基準

1. 運賃データマネージャーは、アクセスごとにファイルから読み込む「キャッシュなし」戦略をサポートすること
2. 運賃データマネージャーは、最初の読み込み後にデータをキャッシュする「シングルトン」戦略をサポートすること
3. 「キャッシュなし」戦略が使用される場合、運賃データマネージャーは運賃データ取得の呼び出しごとにJSONファイルを読み込むこと
4. 「シングルトン」戦略が使用される場合、運賃データマネージャーはJSONファイルを一度だけ読み込み、以降の呼び出しではキャッシュされたデータを返すこと
5. 運賃データマネージャーは、初期化時にキャッシュ戦略を設定できること
6. 運賃データマネージャーは、戦略が指定されていない場合、デフォルトのキャッシュ戦略を提供すること

### 要件3: スレッドセーフティ

**ユーザーストーリー:** 開発者として、運賃データマネージャーがスレッドセーフであることを望む。そうすることで、同時リクエストがデータ破損や競合状態を引き起こさないようにする。

#### 受け入れ基準

1. 「シングルトン」戦略が使用される場合、運賃データマネージャーは初期化中の競合状態を防ぐためにスレッドセーフなロック機構を使用すること
2. 複数のスレッドが同時に運賃データマネージャーにアクセスする場合、運賃データマネージャーは1つのスレッドのみがキャッシュを初期化することを保証すること
3. 複数のスレッドが同時にキャッシュされたデータを読み取る場合、運賃データマネージャーはブロックせずに同時読み取りを許可すること
4. 「キャッシュなし」戦略が使用される場合、運賃データマネージャーはステートレス操作により本質的にスレッドセーフであること

### 要件4: テスタビリティ

**ユーザーストーリー:** 開発者として、運賃データマネージャーを簡単にテストしたい。そうすることで、副作用なしに異なるシナリオでの動作を検証できるようにする。

#### 受け入れ基準

1. 運賃データマネージャーは、テスト目的でキャッシュをクリアするメソッドを提供すること
2. 運賃データマネージャーは、モックデータでテストするためにファイルパスの依存性注入を許可すること
3. キャッシュがクリアされた場合、運賃データマネージャーは次回のアクセス時にファイルからデータを再読み込みすること
4. 運賃データマネージャーは、テストケース間で永続化するグローバルな可変状態に依存しないこと
5. 運賃データマネージャーは、独立したテストのために異なる設定で複数のインスタンスを作成できること

### 要件5: エラーハンドリングの統合

**ユーザーストーリー:** 開発者として、運賃データマネージャーが既存のErrorHandlerと統合されることを望む。そうすることで、エラー報告がアプリケーション全体で一貫性を持つようにする。

#### 受け入れ基準

1. ファイル読み込みエラーが発生した場合、運賃データマネージャーはErrorHandler.handle_fare_data_errorを使用してユーザーフレンドリーなエラーメッセージを生成すること
2. バリデーションエラーが発生した場合、運賃データマネージャーはErrorHandler.handle_validation_errorを使用してユーザーフレンドリーなエラーメッセージを生成すること
3. 運賃データマネージャーは、ErrorHandler.log_infoを使用してデータ読み込み成功をログに記録すること
4. 運賃データマネージャーは、適切なコンテキスト情報とともにErrorHandler.log_errorを使用してエラーをログに記録すること
5. 運賃データマネージャーは、初期化時にErrorHandlerインスタンスを依存性として受け取ること

### 要件6: 運賃計算ツールとの統合

**ユーザーストーリー:** 開発者として、運賃計算ツールが新しい運賃データマネージャーを使用することを望む。そうすることで、公開インターフェースを変更せずに改善されたアーキテクチャの恩恵を受けられるようにする。

#### 受け入れ基準

1. 運賃計算ツールは、load_fare_dataを直接呼び出す代わりに運賃データマネージャーを使用して運賃データを取得すること
2. 運賃計算ツールは、既存の関数シグネチャを維持すること: calculate_fare(departure, destination, transport_type, date)
3. 運賃計算ツールは、FareCalculationInput Pydanticモデルを使用して入力を検証し続けること
4. 運賃計算ツールは、同じ形式で結果を返し続けること: {"fare": float, "calculation_method": str}
5. 電車の経路が運賃データに見つからない場合、運賃計算ツールは説明的なメッセージを含むRuntimeErrorを発生させること
6. 固定運賃の交通手段が要求された場合、運賃計算ツールは運賃データから固定運賃を返すこと

### 要件7: パフォーマンス特性

**ユーザーストーリー:** 開発者として、各キャッシュ戦略のパフォーマンス特性を理解したい。そうすることで、どちらを使用するかについて情報に基づいた決定を下せるようにする。

#### 受け入れ基準

1. 「キャッシュなし」戦略が使用される場合、運賃データマネージャーはデータアクセスごとにファイルI/Oを実行すること
2. 「シングルトン」戦略が使用される場合、運賃データマネージャーはアプリケーションのライフタイム中に一度だけファイルI/Oを実行すること
3. 運賃データマネージャーは、各戦略の期待されるパフォーマンス特性を文書化すること
4. 運賃データマネージャーは、各戦略のメモリ使用量への影響を文書化すること
5. 運賃データマネージャーは、各戦略のスレッド競合特性を文書化すること

### 要件8: 後方互換性

**ユーザーストーリー:** 開発者として、リファクタリングされたコードが後方互換性を維持することを望む。そうすることで、既存のコードが変更なしで動作し続けるようにする。

#### 受け入れ基準

1. 運賃計算ツールは、AWS Strands統合のために既存の@toolデコレータを維持すること
2. 運賃計算ツールは、変更なしで既存のエージェントコードと動作し続けること
3. 運賃データマネージャーは、現在の実装と同じデータ形式をサポートすること
4. 運賃データマネージャーは、現在のload_fare_data関数と同じ構造でデータを返すこと
5. エラーが発生した場合、運賃データマネージャーは現在の動作と一貫して、ユーザーフレンドリーなメッセージを含むRuntimeErrorを発生させること

### 要件9: 設定の柔軟性

**ユーザーストーリー:** 開発者として、キャッシュ戦略を簡単に切り替えたい。そうすることで、コード変更なしに異なるアプローチを試すことができるようにする。

#### 受け入れ基準

1. 運賃データマネージャーは、初期化時にキャッシュ戦略パラメータを受け取ること
2. 運賃データマネージャーは、文字列名による戦略指定をサポートすること（"no-cache"、"singleton"）
3. 運賃データマネージャーは、拡張性のために戦略オブジェクトによる戦略指定をサポートすること
4. 無効な戦略が指定された場合、運賃データマネージャーは有効な戦略のリストを含むValueErrorを発生させること
5. 運賃データマネージャーは、利用可能なすべてのキャッシュ戦略とそのユースケースを文書化すること

### 要件10: メモリ管理

**ユーザーストーリー:** 開発者として、運賃データマネージャーが効率的にメモリを管理することを望む。そうすることで、アプリケーションが過剰なリソースを消費しないようにする。

#### 受け入れ基準

1. 「シングルトン」戦略が使用される場合、運賃データマネージャーはメモリ内に運賃データのコピーを1つだけ保存すること
2. 「キャッシュなし」戦略が使用される場合、運賃データマネージャーはデータを返した後にメモリ内に運賃データを保持しないこと
3. 運賃データマネージャーは、通常の操作中に運賃データの不要なコピーを作成しないこと
4. 運賃データマネージャーは、データを読み取った後すぐにファイルハンドルを解放すること
5. キャッシュがクリアされた場合、運賃データマネージャーはガベージコレクションを可能にするためにキャッシュされたデータを解放すること
